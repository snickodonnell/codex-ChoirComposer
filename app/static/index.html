<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Choir Composer</title>
    <link rel="stylesheet" href="/static/style.css?v=20260217-testdata-fix" />
    <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
    <script src="https://unpkg.com/vexflow@4.2.5/build/cjs/vexflow.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvg@4.0.3/lib/umd.min.js"></script>
  </head>
  <body>
    <main class="container">
      <h1>AI-Assisted Choir Composer</h1>
      <section class="workflow-ribbon" aria-live="polite">
        <strong id="workflowStageLabel">Current stage: 1) Lyrics + Structure</strong>
        <span id="workflowStageHint">Write lyrics, mark Verse sections, and set arrangement order before generating a melody.</span>
      </section>
      <section class="card">
        <h2>1) Lyrics + Structure</h2>
        <div id="sections"></div>
        <button id="addSection" type="button">Add Section</button>
        <button id="loadTestData" type="button">Load Hymn Test Data</button>
        <hr />
        <h3>Arrangement</h3>
        <p>Build song order by reusing section labels from your section library. Verse items are auto-numbered by arrangement order and share one Verse music unit. Non-verse sections keep their own labeled music. Review Phrase Blocks (auto-split from lyric line breaks). By default each block ends at a barline; use “merge with next phrase” for run-on phrasing, optionally add a visual breath marker after a phrase, and configure anacrusis (pickup) manually or via stable auto recommendation.</p>
        <div class="arrangement-controls">
          <label>Add section to arrangement
            <select id="arrangementSectionSelect"></select>
          </label>
          <button id="addArrangementItem" type="button">Add to Arrangement</button>
        </div>
        <div id="arrangementList" class="arrangement-list"></div>
      </section>

      <section class="card grid">
        <div>
          <label>Mood
            <select id="mood">
              <option value="Uplifting" selected>Uplifting</option>
              <option value="Prayerful">Prayerful</option>
              <option value="Joyful">Joyful</option>
              <option value="Reflective">Reflective</option>
              <option value="Triumphant">Triumphant</option>
              <option value="Peaceful">Peaceful</option>
              <option value="Lament">Lament</option>
            </select>
          </label>
          <label>Lyric Rhythm Preset
            <select id="lyricPreset">
              <option value="syllabic">Syllabic</option>
              <option value="mixed" selected>Mixed</option>
              <option value="melismatic">Melismatic</option>
            </select>
          </label>
        </div>
        <div>
          <label>Key (optional)
            <select id="key">
              <option value="">Auto</option>
              <option value="C">C</option>
              <option value="C#">C#</option>
              <option value="Db">Db</option>
              <option value="D">D</option>
              <option value="D#">D#</option>
              <option value="Eb">Eb</option>
              <option value="E">E</option>
              <option value="F">F</option>
              <option value="F#">F#</option>
              <option value="Gb">Gb</option>
              <option value="G">G</option>
              <option value="G#">G#</option>
              <option value="Ab">Ab</option>
              <option value="A">A</option>
              <option value="A#">A#</option>
              <option value="Bb">Bb</option>
              <option value="B">B</option>
              <option value="Cm">Cm</option>
              <option value="C#m">C#m</option>
              <option value="Dbm">Dbm</option>
              <option value="Dm">Dm</option>
              <option value="D#m">D#m</option>
              <option value="Ebm">Ebm</option>
              <option value="Em">Em</option>
              <option value="Fm">Fm</option>
              <option value="F#m">F#m</option>
              <option value="Gbm">Gbm</option>
              <option value="Gm">Gm</option>
              <option value="G#m">G#m</option>
              <option value="Abm">Abm</option>
              <option value="Am">Am</option>
              <option value="A#m">A#m</option>
              <option value="Bbm">Bbm</option>
              <option value="Bm">Bm</option>
            </select>
          </label>
          <label>Primary Mode (optional)
            <select id="primaryMode">
              <option value="">Auto</option>
              <option value="ionian">ionian</option>
              <option value="dorian">dorian</option>
              <option value="phrygian">phrygian</option>
              <option value="lydian">lydian</option>
              <option value="mixolydian">mixolydian</option>
              <option value="aeolian">aeolian</option>
              <option value="locrian">locrian</option>
              <option value="major">major</option>
              <option value="minor">minor</option>
            </select>
          </label>
          <label>Time Signature (optional) <input id="time" placeholder="e.g. 4/4" /></label>
          <label>Tempo BPM (optional) <input id="tempo" type="number" min="30" max="300" /></label>
        </div>
      </section>

      <section class="card">
        <h2>2) Melody Draft</h2>
        <div class="actions">
          <label>Bars per Verse (optional)
            <input id="barsPerVerse" type="number" min="4" max="64" step="1" placeholder="16" />
          </label>
        </div>
        <button id="generateMelody">Generate Melody</button>
        <div id="formErrors" class="form-errors" role="alert"></div>
        <div id="composerWarnings" class="composer-warnings" role="status" style="display:none"></div>
        <div class="actions">
          <button id="regenerate">Regenerate</button>
        </div>
        <div class="actions">
          <label>Regenerate music units
            <select id="regenerateClusters" multiple></select>
          </label>
          <label>Draft version
            <select id="draftVersionSelect"></select>
          </label>
        </div>
        <pre id="melodyMeta"></pre>
        <div id="melodyChords" class="chord-line"></div>
        <div id="melodySheet"></div>
        <div class="preview-panel">
          <div class="preview-panel-header">
            <h3>Preview</h3>
            <div class="actions">
              <button id="refreshMelodyPreview">Refresh Preview</button>
              <label>Zoom
                <input id="melodyPreviewZoom" type="range" min="60" max="180" value="100" />
              </label>
            </div>
          </div>
          <div id="melodyPreviewStatus" class="preview-status">No preview generated yet.</div>
          <div id="melodyPreview" class="preview-svg-wrap"></div>
        </div>
        <div class="actions">
          <button id="startMelody">Start</button>
          <button id="pauseMelody">Pause</button>
          <button id="stopMelody">Stop</button>
        </div>
      </section>

      <section class="card">
        <h2>3) SATB Harmonization</h2>
        <button id="generateSATB">Generate SATB</button>
        <div class="actions">
          <button id="regenerateSATB">Regenerate</button>
        </div>
        <div class="actions">
          <label>Regenerate music units
            <select id="satbRegenerateClusters" multiple></select>
          </label>
          <label>Draft version
            <select id="satbDraftVersionSelect"></select>
          </label>
        </div>
        <pre id="satbMeta"></pre>
        <div id="satbChords" class="chord-line"></div>
        <div id="satbSheet"></div>
        <div class="preview-panel">
          <div class="preview-panel-header">
            <h3>Preview</h3>
            <div class="actions">
              <button id="refreshSatbPreview">Refresh Preview</button>
              <label>Zoom
                <input id="satbPreviewZoom" type="range" min="60" max="180" value="100" />
              </label>
            </div>
          </div>
          <div id="satbPreviewStatus" class="preview-status">No preview generated yet.</div>
          <div id="satbPreview" class="preview-svg-wrap"></div>
        </div>
        <div class="actions">
          <button id="startSATB">Start</button>
          <button id="pauseSATB">Pause</button>
          <button id="stopSATB">Stop</button>
        </div>
      </section>

      <section class="card">
        <h2>4) Export</h2>
        <button id="exportPDF">Download PDF</button>
        <button id="exportMusicXML">Download MusicXML</button>
        <div id="exportPdfStatus" class="preview-status" role="status" aria-live="polite"></div>
        <div id="exportPdfError" class="form-errors" role="alert"></div>
      </section>
    </main>

    <script src="/static/app.js?v=20260217-testdata-fix"></script>
  </body>
</html>
